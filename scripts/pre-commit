#!/bin/bash
# Daem0nMCP Pre-Commit Hook
#
# This hook checks staged files against the AI memory system before committing.
# It ensures that past learnings and warnings are considered.
#
# Installation:
#   ln -sf ../../scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or copy directly:
#   cp scripts/pre-commit .git/hooks/pre-commit

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get the repo root
REPO_ROOT=$(git rev-parse --show-toplevel)

# Check if daem0nmcp CLI is available
if ! python -c "from daem0nmcp.cli import main" 2>/dev/null; then
    echo -e "${YELLOW}[Daem0nMCP] CLI not available, skipping memory check${NC}"
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo -e "${GREEN}[Daem0nMCP] Checking ${#STAGED_FILES[@]} staged file(s) against memory...${NC}"

WARNINGS=0
BLOCKERS=0

for FILE in $STAGED_FILES; do
    # Skip non-code files
    case "$FILE" in
        *.py|*.js|*.ts|*.jsx|*.tsx|*.java|*.go|*.rs|*.rb|*.php)
            ;;
        *)
            continue
            ;;
    esac

    # Run context check for this file
    RESULT=$(python -m daem0nmcp.cli check "$FILE" 2>/dev/null || echo "")

    if echo "$RESULT" | grep -q "WARNING"; then
        echo -e "${YELLOW}[Daem0nMCP] Warning for $FILE:${NC}"
        echo "$RESULT" | grep -A2 "WARNING"
        WARNINGS=$((WARNINGS + 1))
    fi

    if echo "$RESULT" | grep -q "BLOCKER"; then
        echo -e "${RED}[Daem0nMCP] BLOCKER for $FILE:${NC}"
        echo "$RESULT" | grep -A2 "BLOCKER"
        BLOCKERS=$((BLOCKERS + 1))
    fi
done

# Summary
if [ $BLOCKERS -gt 0 ]; then
    echo -e "${RED}[Daem0nMCP] $BLOCKERS blocker(s) found. Commit blocked.${NC}"
    echo -e "${RED}Use 'git commit --no-verify' to bypass (not recommended).${NC}"
    exit 1
fi

if [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}[Daem0nMCP] $WARNINGS warning(s) found. Review before committing.${NC}"
fi

echo -e "${GREEN}[Daem0nMCP] Memory check complete.${NC}"
exit 0
